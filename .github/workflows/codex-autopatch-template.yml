name: Codex Autopatch Template

# This is a reusable workflow that agent repositories can import
# Usage in agent repos:
#   uses: PR-CYBR/PR-CYBR-P0D/.github/workflows/codex-autopatch-template.yml@main

on:
  workflow_call:
    inputs:
      issue_number:
        description: 'Issue number to process'
        required: true
        type: number
      issue_title:
        description: 'Issue title'
        required: true
        type: string
      issue_body:
        description: 'Issue body/description'
        required: true
        type: string
      meeting_id:
        description: 'Meeting ID (extracted from labels)'
        required: false
        type: string
        default: ''
    secrets:
      GITHUB_TOKEN:
        required: true

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  autopatch:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Extract task metadata
        id: metadata
        run: |
          # Extract task ID from issue title [TASK_ID] format
          TASK_ID=$(echo "${{ inputs.issue_title }}" | grep -oP '\[.*?\]' | tr -d '[]' || echo "UNKNOWN")
          echo "task_id=$TASK_ID" >> $GITHUB_OUTPUT
          
          # Generate branch name
          BRANCH_NAME="codex/issue-${{ inputs.issue_number }}-$(echo $TASK_ID | tr '[:upper:]' '[:lower:]' | tr '_' '-')"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          
          echo "Task ID: $TASK_ID"
          echo "Branch: $BRANCH_NAME"
      
      - name: Create feature branch
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          BRANCH="${{ steps.metadata.outputs.branch_name }}"
          git checkout -b "$BRANCH"
          echo "âœ… Created branch: $BRANCH"
      
      - name: Run Codex modifications
        run: |
          echo "ðŸ¤– Running Codex AI modifications..."
          
          # Pull and run the codex-runner container
          docker pull ghcr.io/pr-cybr/codex-runner:latest || {
            echo "âš ï¸  Codex runner image not available, using placeholder"
            # Placeholder: In production, this would run actual codex CLI
            echo "# Codex would make automated code changes here" > CODEX_CHANGES.md
            echo "Issue #${{ inputs.issue_number }}: ${{ inputs.issue_title }}" >> CODEX_CHANGES.md
            exit 0
          }
          
          # Run codex container with issue context
          docker run --rm \
            -v "$(pwd):/workspace" \
            -e "ISSUE_NUMBER=${{ inputs.issue_number }}" \
            -e "ISSUE_TITLE=${{ inputs.issue_title }}" \
            -e "ISSUE_BODY=${{ inputs.issue_body }}" \
            ghcr.io/pr-cybr/codex-runner:latest \
            codex autopatch --issue "${{ inputs.issue_number }}" || {
              echo "âš ï¸  Codex execution failed, continuing with manual process"
              exit 0
            }
          
          echo "âœ… Codex modifications complete"
      
      - name: Run tests
        id: tests
        run: |
          echo "ðŸ§ª Running tests..."
          
          # Check for common test scripts
          if [ -f "package.json" ]; then
            if command -v npm &> /dev/null; then
              npm test || echo "test_status=failed" >> $GITHUB_OUTPUT
            fi
          elif [ -f "pytest.ini" ] || [ -f "setup.py" ]; then
            if command -v pytest &> /dev/null; then
              pytest || echo "test_status=failed" >> $GITHUB_OUTPUT
            fi
          elif [ -f "Makefile" ]; then
            make test || echo "test_status=failed" >> $GITHUB_OUTPUT
          else
            echo "No test configuration found, skipping tests"
            echo "test_status=skipped" >> $GITHUB_OUTPUT
          fi
          
          # If no test status set, mark as passed
          if ! grep -q "test_status" <<< "$GITHUB_OUTPUT" 2>/dev/null; then
            echo "test_status=passed" >> $GITHUB_OUTPUT
          fi
      
      - name: Commit changes
        id: commit
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Add all changes
          git add -A
          
          # Check if there are changes
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No changes to commit"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            
            # Commit changes
            TASK_ID="${{ steps.metadata.outputs.task_id }}"
            git commit -m "feat: automated fixes for issue #${{ inputs.issue_number }}" \
                       -m "Task: $TASK_ID" \
                       -m "Automated by Codex" \
                       -m "Refs: #${{ inputs.issue_number }}"
            
            # Push branch
            git push -u origin "${{ steps.metadata.outputs.branch_name }}"
            echo "âœ… Changes committed and pushed"
          fi
      
      - name: Create pull request
        if: steps.commit.outputs.has_changes == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TASK_ID="${{ steps.metadata.outputs.task_id }}"
          BRANCH="${{ steps.metadata.outputs.branch_name }}"
          MEETING_REF=""
          
          if [ -n "${{ inputs.meeting_id }}" ]; then
            MEETING_REF="Meeting: ${{ inputs.meeting_id }}"
          fi
          
          # Create PR body
          PR_BODY="## Automated Fix for Issue #${{ inputs.issue_number }}

          **Task ID:** \`$TASK_ID\`
          **Issue:** #${{ inputs.issue_number }}
          $MEETING_REF

          ### Changes
          This PR contains automated fixes generated by Codex AI.

          ### Original Issue
          ${{ inputs.issue_body }}

          ### Test Status
          - Tests: ${{ steps.tests.outputs.test_status }}

          ---
          *This PR was automatically generated by the Codex autopatch workflow.*
          *Please review changes carefully before merging.*"
          
          # Create PR using GitHub CLI or API
          gh pr create \
            --title "ðŸ¤– Auto: ${{ inputs.issue_title }}" \
            --body "$PR_BODY" \
            --base main \
            --head "$BRANCH" \
            --label "automation/codex" \
            --label "needs-review" || {
              echo "âš ï¸  Failed to create PR via gh CLI, trying API..."
              
              curl -X POST \
                -H "Accept: application/vnd.github.v3+json" \
                -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                "https://api.github.com/repos/${{ github.repository }}/pulls" \
                -d "{
                  \"title\": \"ðŸ¤– Auto: ${{ inputs.issue_title }}\",
                  \"body\": $(echo "$PR_BODY" | jq -Rs .),
                  \"head\": \"$BRANCH\",
                  \"base\": \"main\"
                }"
            }
          
          echo "âœ… Pull request created"
      
      - name: Add comment to issue
        if: steps.commit.outputs.has_changes == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          COMMENT="ðŸ¤– **Codex Autopatch Complete**

          I've analyzed this issue and created automated fixes.

          **Status:** âœ… Changes committed
          **Branch:** \`${{ steps.metadata.outputs.branch_name }}\`
          **Tests:** ${{ steps.tests.outputs.test_status }}

          A pull request has been created with the proposed changes. Please review and merge if the changes look good."
          
          gh issue comment ${{ inputs.issue_number }} --body "$COMMENT" || {
            curl -X POST \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/issues/${{ inputs.issue_number }}/comments" \
              -d "{\"body\": $(echo "$COMMENT" | jq -Rs .)}"
          }
      
      - name: Summary
        run: |
          echo "### Codex Autopatch Complete ðŸ¤–" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Issue:** #${{ inputs.issue_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Task ID:** ${{ steps.metadata.outputs.task_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ steps.metadata.outputs.branch_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.commit.outputs.has_changes }}" == "true" ]; then
            echo "âœ… Changes committed and PR created" >> $GITHUB_STEP_SUMMARY
            echo "**Test Status:** ${{ steps.tests.outputs.test_status }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ No changes were needed" >> $GITHUB_STEP_SUMMARY
          fi
